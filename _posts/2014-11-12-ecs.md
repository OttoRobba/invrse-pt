---
layout:     post
title:      Introdução aos componentes e entidades
date:       2014-11-12 20:00:00
permalink:  sistema-entidades-e-componentes
categories: 
    - tutorial
    - programming
comments:   true
---

Tente imaginar que você está desenvolvendo um rpg. O jogador terá a opção de escolher entre 4 personagens que diferem bastante entre si - deve ser fácil o bastante criá-los na maneira clássica (ou até mesmo como simples objetos). Por exemplo:

{%highlight javascript%}
var Hero = function() {
    this.health = 100;
    this.power = 20;
    this.sprite = 'hero.png';
    this.weapon = 'spear';
    this.damage = 20;
};

var hero1 = new Hero();
{%endhighlight%}

###Sem tempo para orcs velhos

Legal, funciona - mas esta longe de ser ideal. O que fazer se precisarmos adicionar mais personagens? E como faremos com os inimigos?

Vamos deixar de lado os personagens extras por enquanto (fica pra uma DLC) e vamos focar nos monstros e inimigos. Como estamos fazendo um rpg tradicional, não poderiam faltar orcs - e nós queremos que eles sejam gerados aleatoriamente (yay diversidade) a partir de uma lista de possíveis atributos.

Queremos que alguns sejam extra-fortes e outros que sejam meio fracos, queremos alguns com arcos e outros com machados.

Um jeito muito legal de resolver esse problema é usando-se do sistema de entidades e componentes.

![Avengers, assemble!]({{site.baseurl}}/assets/ecs_orc.png)

###Rangers, montem o Megazord!

Imagina componentes como os menores blocos que, montados, formam uma entidade. Para nossas pessoas-orc, poderíamos fazer algo assim:

{%highlight javascript%}
var components = {
  orc: function(entity) {
    entity.health = 100;
    entity.humanoid = true;
    entity.color = 'green';
  },

  strong: function(entity) {
    if(entity.health !== null)
      entity.health = entity.health*1.25;
  },
  
  axe: function(entity) {
    entity.weapon = 'Axe';
    entity.damage = 5;
    entity.critMulti = 4;
    entity.critChance = 20;
  }
};
{%endhighlight%}

E daí se fizessemos algo assim:

{%highlight javascript%}
var orc1 = {};
components.orc(orc1);
components.strong(orc1);
components.axe(orc1);
{%endhighlight%}

Teríamos um orc durão armado até os dentes! Beleza! O legal é que se a gente quiser reaproveitar e criar um humano, poderíamos usar tanto o método strong() como o axe().

###Sistematicamente

Tá, o código acima dá conta das entidades e de seus componentes. Mas nós não temos muitas maneiras de interagir com eles sem perder a sanidade.

É aqui que as coisas ficam interessantes. A lógica dos componentes (e de suas entidades) é administrada por sistemas específicos - por exemplo, o de física vai checar colisões e afins para entidades que tenham o componente 'physics'.

Pra tornar isso possível, o primeiro passo é colocar todas as nossas entidades numa lista para que possamos referenciá-las e iterar por elas, permitindo coisas assim:

{%highlight javascript%}
//Inimigos só te enfrentam se vocês dois estiverem armados ou desarmados
//Quando em desvantagem, eles fogem
for (var i = 0; i < entities.length; i++) {
    if (player.armed && !entity[i].armed) {
        entity[i].run();
    } else {
        entity[i].fight();
    }
}
{%endhighlight%}

###Aprimorando nosso ECS

Eu sei que agora você deve estar pensando "Espera um pouco - você poderia ter refinado mais, quebrado o sistema em partes menores!". Você tem razão - coisas como a vida do personagem, por exemplo, podiam ser um componente por si só.

Você poderia agrupar alguns componentes para facilitar a criação de entidades. Outra coisa que podemos fazer é refinar nossa função para permitir as chamadas em cascata. Veja só:

{%highlight javascript%}
var ECS = function() {
  return { //Retornamos os componentes
      health: function() {
        this.health = 100;
        //Retornamos o objeto pois isso nos permite criar as cadeias de chamadas
        return this;        
      },
      strong: function() {
          if(this.health !== null)
              this.health = this.health*1.25;
          return this;
      }
  };
};
{%endhighlight%}

Ganhamos aqui muita flexibilidade e podemos criar entidades assim agora:

{%highlight javascript%}
var orc = new ECS();
orc.health().strong(); //Bem simples

var orc2 = new ECS()
    .health()
    .strong(); //Mais simples ainda
{%endhighlight%}

###Exemplos do mundo real

<a href="craftyjs.com/" target="_blank">CraftyJS</a> é um framework de jogos construído em torno da ideia de ECS. Existem também frameworks independentes que podem ser adaptados para engines, tais como o <a href="https://github.com/qiao/ces.js" target="_blank">ces.js</a> ou você poderia criar o seu! Um bom lugar para aprender mais é no <a href="http://vasir.net/blog/game-development/how-to-build-entity-component-system-in-javascript" target="_blank">tutorial do devorador de retângulos</a> (em inglês).

Espero que isso tenha sido útil, me deixe saber o que você achou nos comentários abaixo!